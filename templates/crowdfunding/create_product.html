{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Create Product - Innovest{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <h1 class="mb-4">Create Your Product</h1>
            
            <div class="card shadow-sm">
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" id="productForm" class="needs-validation" novalidate>
                        {% csrf_token %}
                        
                        <!-- Basic Information -->
                        <h4 class="mb-4">Basic Information</h4>
                        <div class="row g-3">
                            <div class="col-12">
                                {{ form.title|as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                {{ form.category|as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                {{ form.website|as_crispy_field }}
                            </div>
                            <div class="col-12">
                                {{ form.short_description|as_crispy_field }}
                            </div>
                            <div class="col-12">
                                {{ form.description|as_crispy_field }}
                            </div>
                        </div>

                        <hr class="my-4">

                        <!-- Media -->
                        <h4 class="mb-4">Media</h4>
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">Cover Image</label>
                                <div class="input-group">
                                    {{ form.cover_image }}
                                </div>
                                <div id="coverPreview" class="mt-2"></div>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Gallery Images</label>
                                <div class="input-group">
                                    <input type="file" name="gallery_images" multiple accept="image/*" class="form-control" id="id_gallery_images">
                                </div>
                                <small class="text-muted">Hold Ctrl to select multiple images. Maximum size: 5MB per image.</small>
                                <div id="galleryPreview" class="mt-2 row g-2"></div>
                            </div>
                            <div class="col-12">
                                {{ form.video_url|as_crispy_field }}
                            </div>
                        </div>

                        <hr class="my-4">

                        <!-- Funding Details -->
                        <h4 class="mb-4">Funding Details</h4>
                        <div class="row g-3">
                            <div class="col-md-6">
                                {{ form.goal_amount|as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                {{ form.minimum_investment|as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                {{ form.equity_offered|as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                {{ form.business_plan|as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                {{ form.start_date|as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                {{ form.end_date|as_crispy_field }}
                            </div>
                        </div>

                        <hr class="my-4">

                        <!-- Risks -->
                        <h4 class="mb-4">Risks & Challenges</h4>
                        <div class="row g-3">
                            <div class="col-12">
                                {{ form.risks|as_crispy_field }}
                            </div>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <button type="button" class="btn btn-outline-secondary me-md-2" onclick="history.back()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Create Product</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Image preview functionality
    function handleFileSelect(event, previewId) {
        const preview = document.getElementById(previewId);
        preview.innerHTML = '';
        
        const files = event.target.files;
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            if (!file.type.startsWith('image/')) {
                alert(`File "${file.name}" is not an image`);
                continue;
            }
            if (file.size > 5 * 1024 * 1024) {
                alert(`File "${file.name}" is too large (> 5MB)`);
                continue;
            }
            
            const reader = new FileReader();
            reader.onload = (function(file) {
                return function(e) {
                    const div = document.createElement('div');
                    div.className = previewId === 'coverPreview' ? 'mt-2' : 'col-4 col-md-3';
                    div.innerHTML = `
                        <img src="${e.target.result}" 
                             class="img-fluid rounded" 
                             style="max-height: 200px; object-fit: cover;"
                             alt="${file.name}">
                    `;
                    preview.appendChild(div);
                };
            })(file);
            reader.readAsDataURL(file);
        }
    }

    // Set up file input listeners
    document.getElementById('id_cover_image').addEventListener('change', function(e) {
        handleFileSelect(e, 'coverPreview');
    });
    
    document.getElementById('id_gallery_images').addEventListener('change', function(e) {
        handleFileSelect(e, 'galleryPreview');
    });

    // Form validation
    (function() {
        'use strict';
        const form = document.getElementById('productForm');
        form.addEventListener('submit', function(event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        }, false);
    })();
</script>
{% endblock %} 